<div id="settings_plugin_octoprint_uptime" class="form-horizontal">
  <fieldset>
    <legend>{{ _("OctoPrint-Uptime") }}</legend>
    <p>{{ _("Use this plugin to display system uptime in the Navbar.") }}</p>

    <div id="uptime_note_container" data-note="{{ _('Uptime could not be determined. You can install psutil in the OctoPrint virtualenv: pip install psutil')|e }}" style="display:none; margin-bottom:10px;"></div>

    <script type="text/javascript">
      (function() {
        $(function() {
          var $uptimeContainer = $('#settings_plugin_octoprint_uptime');
          var uptimeNoteRendered = false;

          function _renderUptimeNote(data) {
            try {
              if (data && data.uptime_available === false) {
                var installNote = $('#uptime_note_container').attr('data-note') || '';
                var el = $('<div/>')
                  .addClass('alert alert-warning')
                  .text(installNote);
                $('#uptime_note_container').empty().append(el).show();
              }
            } catch (e) {
              if (typeof window.UptimeDebug !== 'undefined' && window.UptimeDebug) {
                console.error('octoprint_uptime: error handling uptime API response in settings template', e, data);
              } else {
                console.warn('octoprint_uptime: error handling uptime API response in settings template');
              }
            }
          }

          function _fetchUptimeNote() {
            if (uptimeNoteRendered) {
              return;
            }
            return OctoPrint.simpleApiGet('octoprint_uptime')
              .done(function(data) {
                _renderUptimeNote(data);
                uptimeNoteRendered = true;
              })
              .fail(function(jqXHR, textStatus, errorThrown) {
                if (typeof window.UptimeDebug !== 'undefined' && window.UptimeDebug) {
                  console.error('octoprint_uptime: failed to fetch uptime API for settings template', textStatus, errorThrown, jqXHR);
                } else {
                  console.warn('octoprint_uptime: failed to fetch uptime API for settings template:', textStatus);
                }
              });
          }

          // If the settings section is already visible, fetch immediately;
          // otherwise wait for the settings modal to be shown to avoid extra
          // requests when navigating settings pages.
          if ($uptimeContainer.is(':visible')) {
            _fetchUptimeNote();
          } else {
            var $modal = $uptimeContainer.closest('.modal');
            $modal.on('shown.bs.modal shown', function _uptimeModalHandler() {
              $modal.off('shown.bs.modal shown', _uptimeModalHandler);
              _fetchUptimeNote();
            });
          }
        });
      })();
    </script>

      <div class="control-group">
        <label class="control-label" for="plugin_uptime_navbar">{{ _("Navbar") }}</label>
        <div class="controls">
          <label class="checkbox" for="plugin_uptime_navbar">
            <input
              id="plugin_uptime_navbar"
              type="checkbox"
              data-bind="checked: settings.plugins.octoprint_uptime.navbar_enabled"
            />
            {{ _("Show uptime in navbar") }}
          </label>
          <p class="help-block">{{ _("Toggle whether the uptime is visible in the top navigation bar.") }}</p>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="plugin_uptime_format">{{ _("Display format") }}</label>
        <div class="controls">
          <select id="plugin_uptime_format" data-bind="value: settings.plugins.octoprint_uptime.display_format" class="span3">
            <option value="full">{{ _("D + H + M + S (days + hours + minutes + seconds)") }}</option>
            <option value="dhm">{{ _("D + H + M (days + hours + minutes)") }}</option>
            <option value="dh">{{ _("D + H (days + hours)") }}</option>
            <option value="d">{{ _("D (days only)") }}</option>
          </select>
          <p class="help-block">{{ _("Choose how the uptime is shown in the navbar.") }}</p>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="plugin_uptime_poll_interval">{{ _("Polling interval (s)") }}</label>
        <div class="controls">
          <input id="plugin_uptime_poll_interval" type="number" class="span2" min="1" data-bind="value: settings.plugins.octoprint_uptime.poll_interval_seconds" />
          <p class="help-block">{{ _("Seconds between navbar API polls. Low values may spam logs; default is 5s.") }}</p>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="plugin_uptime_debug">{{ _("Debug") }}</label>
        <div class="controls">
          <label class="checkbox" for="plugin_uptime_debug">
            <input
              id="plugin_uptime_debug"
              type="checkbox"
              data-bind="checked: settings.plugins.octoprint_uptime.debug"
            />
            {{ _("Enable debug logging (throttled)") }}
          </label>
          <p class="help-block">{{ _("When enabled, the plugin will log debug messages. Messages are throttled to avoid spamming the log.") }}</p>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="plugin_uptime_throttle">{{ _("Debug throttle (s)") }}</label>
        <div class="controls">
          <input id="plugin_uptime_throttle" type="number" class="span2" min="1" data-bind="value: settings.plugins.octoprint_uptime.debug_throttle_seconds" />
          <p class="help-block">{{ _("Minimum seconds between debug log entries.") }}</p>
        </div>
      </div>

  </fieldset>
</div>
