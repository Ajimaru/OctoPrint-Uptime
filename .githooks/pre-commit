#!/usr/bin/env bash

# If running on native Windows, re-exec this hook under Git Bash if available.
# This is idempotent: if already running under Bash it does nothing.
_SCRIPT_DIR_HINT="$(cd "$(dirname "$0")" >/dev/null 2>&1 && pwd || dirname "$0")"
REPO_ROOT="$(cd "$_SCRIPT_DIR_HINT/.." >/dev/null 2>&1 && pwd || echo "$_SCRIPT_DIR_HINT")"
WRAPPER="$REPO_ROOT/.development/win-bash-wrapper.sh"
if [ -z "${BASH_VERSION-}" ]; then
    if [ -x "$WRAPPER" ]; then
        exec "$WRAPPER" "$0" "$@"
    elif command -v bash >/dev/null 2>&1; then
        exec bash "$0" "$@"
    fi
fi

# Description: Wrapper to run pre-commit hooks from the repository virtualenv.
# Behavior:
#  - Attempts to execute `./venv/bin/pre-commit` to ensure hooks run inside the project's venv.
#  - Validates that the venv Python meets the minimum required version (Python 3.10+).
#  - Optionally runs `pre-commit autoupdate` once per 24h when `PRECOMMIT_AUTOUPDATE=1`.
# Usage:
#  - Installed as a git hook via `core.hooksPath` and invoked automatically by Git.

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

python_is_at_least_310() {
    local python_bin="$1"
    "$python_bin" -c 'import sys; sys.exit(0 if sys.version_info[:2] >= (3, 10) else 1)' >/dev/null 2>&1
}

run_pre_commit_from_venv() {
    local venv_dir="$1"
    local python_bin="$venv_dir/bin/python"
    local pre_commit_bin="$venv_dir/bin/pre-commit"

    if [[ ! -x "$pre_commit_bin" || ! -x "$python_bin" ]]; then
        return 1
    fi

    if ! python_is_at_least_310 "$python_bin"; then
        echo "ERROR: $python_bin is < 3.10; pre-commit hooks require Python 3.10+" >&2
        return 2
    fi

    exec "$pre_commit_bin" run --hook-stage pre-commit --show-diff-on-failure --color=always
}

run_pre_commit_from_venv "./venv"

echo "ERROR: pre-commit not available in ./venv. Run: .development/setup_dev.sh" >&2
exit 1

maybe_run_autoupdate() {
    # If PRECOMMIT_AUTOUPDATE=1 is set in the environment, run autoupdate
    # at most once per 24 hours. This avoids network calls on every commit.
    local marker_file
    marker_file="$(git rev-parse --git-common-dir 2>/dev/null)/pre-commit-autoupdate"

    if [[ "${PRECOMMIT_AUTOUPDATE:-0}" != "1" ]]; then
        return 0
    fi

    local now
    now=$(date +%s)
    if [[ -f "$marker_file" ]]; then
        local last
        last=$(cat "$marker_file" 2>/dev/null || echo 0)
        if (( now - last < 86400 )); then
            return 0
        fi
    fi

    if [[ -x "./venv/bin/pre-commit" ]]; then
        echo "PRECOMMIT_AUTOUPDATE=1: running 'pre-commit autoupdate'..."
        # Run autoupdate but do not auto-stage or commit changes; user must review.
        ./venv/bin/pre-commit autoupdate || true
        date +%s > "$marker_file" || true
    else
        echo "PRECOMMIT_AUTOUPDATE=1 but ./venv/bin/pre-commit not available" >&2
    fi
}

# Try running autoupdate (no-op unless PRECOMMIT_AUTOUPDATE=1)
maybe_run_autoupdate

