name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    env:
      BABEL_VERSION: "2.18.0"
      POLIB_VERSION: "1.2.0"
      BANDIT_VERSION: "1.9.3"

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    steps:
      - # Checkout repository code
        name: Checkout
        uses: actions/checkout@v6

      - # Setup Python version and pip cache
        name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - # Display Python and pip versions for debugging
        name: Show tool versions
        run: |
          python --version
          pip --version

      - # Upgrade pip and build tools
        name: Upgrade pip/setuptools/wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - # Install pre-commit and Babel for linting
        name: Install minimal dev dependencies for CI
        run: |
          python -m pip install pre-commit "Babel==${{ env.BABEL_VERSION }}" "polib==${{ env.POLIB_VERSION }}"

      - # Cache pre-commit hooks to speed up subsequent runs
        name: Cache pre-commit
        id: cache-precommit
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-${{ matrix.python-version }}-
            pre-commit-${{ runner.os }}-

      - # Setup Node.js for ESLint and other JS-based hooks
        name: Set up Node.js for hooks
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.0"
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - # Install npm dependencies for pre-commit hooks
        name: Install Node.js dependencies for hooks
        run: |
          if [ -f package-lock.json ] || [ -f package.json ]; then
            npm ci --no-audit --no-fund || npm install --no-audit --no-fund
          fi

      - # Create venv and install Babel for i18n validation
        name: Create ./venv for translation check
        run: |
          python -m venv venv
          . venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install "Babel==${{ env.BABEL_VERSION }}" "polib==${{ env.POLIB_VERSION }}"

      - # Install ShellCheck >= 0.11.0 required by custom shellcheck-hook.sh
        name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck || true

      - # Execute all pre-commit hooks on repository
        name: Run pre-commit on all files
        run: |
          pre-commit run --all-files --show-diff-on-failure --color always

      - # Run Bandit security scanner
        name: Bandit (security)
        if: success() || failure()
        run: |
          pip install "bandit==${{ env.BANDIT_VERSION }}"
          bandit -r octoprint_uptime -x .venv,venv,.git -ll
      - # Print summary message
        name: Summary
        if: always()
        run: |
          echo "âœ… Linting finished for Python ${{ matrix.python-version }}"
